<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector y Grabadora de Audio</title>
</head>
<body>
    <h1>Detector de Audio Independencia</h1>
    <label for="umbralInput">Umbral de Decibelios:</label>
    <input type="range" id="umbralInput" min="0" max="100" value="10" step="1" oninput="updateUmbral()">
    <span id="umbralValue">1.0</span>
    <div id="eventCounter">Veces que se ha superado el umbral: 0</div>
    <br/>
    <button onclick="startAudioDetection()">Iniciar Detección</button>
    <button onclick="stopAudioDetection()">Detener Detección</button>
    <button onclick="saveInformation()">Guardar Información</button>
    <div id="powerDisplay">Potencia de Audio: 0 dB</div>
    
    
    <hr>

    <h1>Grabadora de Audio</h1>
    <button id="startRecord">Iniciar Grabación</button>
    <button id="stopRecord" disabled>Detener Grabación</button>
    <audio id="audioPlayer" controls></audio>
    
    <hr>
    
    <div id="eventLog"></div>

    <script>
        let audioContext;
        let analyser;
        let microphoneStream;
        let eventLogElement;
        let eventCounterElement;
        let count = 0;
        let lastSpeechTime = 0;
        const speechCooldownDuration = 30000;
        let umbralDecibelios = 1.0;
        let umbralValue = document.getElementById('umbralValue');

        function updateUmbral() {
            umbralDecibelios = parseFloat((parseInt(document.getElementById('umbralInput').value) / 10).toFixed(1));
            umbralValue.textContent = umbralDecibelios.toFixed(1);
        }

        function startAudioDetection() {
            eventLogElement = document.getElementById('eventLog');
            eventCounterElement = document.getElementById('eventCounter');

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    microphoneStream = audioContext.createMediaStreamSource(stream);

                    microphoneStream.connect(analyser);
                    analyser.connect(audioContext.destination);

                    analyser.fftSize = 256;
                    analyser.smoothingTimeConstant = 0.5;

                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    analyser.getByteTimeDomainData(dataArray);

                    function detectAudio() {
                        analyser.getByteTimeDomainData(dataArray);

                        const rms = Math.sqrt(Array.from(dataArray).reduce((sum, sample) => sum + Math.abs(sample) * Math.abs(sample), 0) / dataArray.length);
                        const dB = 20 * Math.log10(rms / 128.0);

                        document.getElementById('powerDisplay').innerText = `Potencia de Audio: ${dB.toFixed(2)} dB`;

                        if (dB > umbralDecibelios && !isSpeechCooldownActive()) {
                            const evento = `Evento detectado a las ${getCurrentTime()} con potencia ${dB.toFixed(2)} dB`;
                            logEvent(evento);
                            count++;
                            updateEventCounter();
                            readEventCount();
                        }

                        requestAnimationFrame(detectAudio);
                    }

                    detectAudio();
                })
                .catch(function (err) {
                    console.error("Error al obtener acceso al micrófono:", err);
                });
        }

        function stopAudioDetection() {
            if (microphoneStream) {
                microphoneStream.disconnect();
                analyser.disconnect();
                audioContext.close().then(() => {
                    console.log("Detección de audio detenida.");
                });
            }
        }

        function logEvent(message) {
            const eventItem = document.createElement('div');
            eventItem.innerText = message;

            eventLogElement.insertBefore(eventItem, eventLogElement.firstChild);
        }

        function updateEventCounter() {
            eventCounterElement.innerText = `Veces que se ha superado el umbral: ${count}`;
        }

        function readEventCount() {
            pauseAudioDetection();

            const synth = window.speechSynthesis;
            const message = `Dario tu empresa afecta a los Vecinos con Ruido Excesivo y Olores Tóxicos. Generando Informe: ${count}.`;
            const utterance = new SpeechSynthesisUtterance(message);
            utterance.onend = () => {
                resumeAudioDetection();
                readDateTime();
            };
            synth.speak(utterance);

            lastSpeechTime = Date.now();
        }

        function isSpeechCooldownActive() {
            return Date.now() - lastSpeechTime < speechCooldownDuration;
        }

        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const ampm = hours >= 12 ? 'pm' : 'am';
            const hourText = hours % 12 === 0 ? 12 : hours % 12;
            const minuteText = minutes < 10 ? `0${minutes}` : minutes;
            return `${hourText}:${minuteText} ${ampm}`;
        }

        function pauseAudioDetection() {
            if (microphoneStream) {
                microphoneStream.disconnect();
            }
        }

        function resumeAudioDetection() {
            if (microphoneStream && analyser) {
                microphoneStream.connect(analyser);
            }
        }

        function readDateTime() {
            const now = new Date();
            const options = { hour: 'numeric', minute: 'numeric', hour12: true };
            const dateTimeString = now.toLocaleString('en-MX', options);
            const synth = window.speechSynthesis;
            const utterance = new SpeechSynthesisUtterance(`Hora actual: ${dateTimeString}`);
            synth.speak(utterance);
        }

        function saveInformation() {
            const events = Array.from(document.getElementById('eventLog').children).map(event => event.innerText);
            const content = `Registro de eventos con el detector de audio:\n${events.join('\n')}`;

            const blob = new Blob([content], { type: 'text/plain' });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'registro_eventos.txt';

            link.click();
        }

        let mediaRecorder;
        let audioChunks = [];

        const startRecordButton = document.getElementById('startRecord');
        const stopRecordButton = document.getElementById('stopRecord');
        const audioPlayer = document.getElementById('audioPlayer');

        startRecordButton.addEventListener('click', startRecording);
        stopRecordButton.addEventListener('click', stopRecording);

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioUrl;
            };

            mediaRecorder.start();
            startRecordButton.disabled = true;
            stopRecordButton.disabled = false;
        }

        function stopRecording() {
            mediaRecorder.stop();
            startRecordButton.disabled = false;
            stopRecordButton.disabled = true;
        }
    </script>
</body>
</html>
