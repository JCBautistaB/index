<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector y Grabadora de Audio</title>
</head>
<body>
    <h1>Detector de Audio Independencia</h1>
    <label for="umbralInput">Umbral de Decibelios:</label>
    <input type="range" id="umbralInput" min="0" max="100" value="10" step="1" oninput="updateUmbral()">
    <span id="umbralValue">1.0</span>
    <div id="eventCounter">Veces que se ha superado el umbral: 0</div>
    <br/>
    <label for="customMessage">Mensaje Personalizado:</label>
    <input type="text" id="customMessage" placeholder="Ingresa tu mensaje">
    <br/>
    <label for="cooldownInput">Tiempo de Espera (en segundos):</label>
    <input type="number" id="cooldownInput" placeholder="30"> <!-- Valor predeterminado es 30 segundos -->

    <div id="countdownTimer"></div> <!-- Agregado: Mostrará el tiempo restante -->

    <!-- Agregado: Botón para solicitar permisos -->
    <button onclick="requestMicrophonePermission()">Permitir acceso al micrófono</button>

    <br/>
    <button onclick="startAudioDetection()">Iniciar Detección</button>
    <button onclick="stopAudioDetection()">Detener Detección</button>
    <button onclick="saveInformation()">Guardar Información</button>
    <div id="powerDisplay">Potencia de Audio: 0 dB</div>

    <hr>

    <h1>Grabadora de Audio</h1>
    <!-- Agregar campo de texto para la palabra clave 'Inicia' y 'Alto' -->
    <label for="startKeywordInput">Palabra Clave para 'Inicia':</label>
    <input type="text" id="startKeywordInput" placeholder="inicia">
    <br/>
    <label for="stopKeywordInput">Palabra Clave para 'Alto':</label>
    <input type="text" id="stopKeywordInput" placeholder="para">
    <br/>
    <button id="startRecord" onclick="startRecording()">Iniciar Grabación</button>
    <button id="stopRecord" onclick="stopRecording()" disabled>Detener Grabación</button>
    <span id="recordingIndicator" style="color: red; font-weight: bold;"></span> <!-- Nuevo: Indicador visual -->
    <audio id="audioPlayer" controls></audio>
    <p>Palabra clave reconocida: <span id="keywordRecognized"></span></p>

    <hr>

    <div id="eventLog"></div>

    <script>
        let audioContext;
        let analyser;
        let microphoneStream;
        let eventLogElement;
        let eventCounterElement;
        let count = 0;
        let lastSpeechTime = 0;
        let speechCooldownDuration = 30000; // Valor predeterminado en milisegundos
        let umbralDecibelios = 1.0;
        let umbralValue = document.getElementById('umbralValue');
        let countdownInterval;
        let startKeyword;
        let stopKeyword;

        function updateUmbral() {
            umbralDecibelios = parseFloat((parseInt(document.getElementById('umbralInput').value) / 10).toFixed(1));
            umbralValue.textContent = umbralDecibelios.toFixed(1);
        }

        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // Continuar con la lógica de audio después de obtener el permiso
            } catch (error) {
                console.error("Error al obtener acceso al micrófono:", error);
            }
        }

        function startAudioDetection() {
            eventLogElement = document.getElementById('eventLog');
            eventCounterElement = document.getElementById('eventCounter');

            const cooldownInput = document.getElementById('cooldownInput').value;
            speechCooldownDuration = (cooldownInput || 30) * 1000; // Convertir a milisegundos, usar 30 segundos si no se proporciona un valor

            // Obtener las palabras clave del campo de texto
            startKeyword = document.getElementById('startKeywordInput').value.trim().toLowerCase();
            stopKeyword = document.getElementById('stopKeywordInput').value.trim().toLowerCase();

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    microphoneStream = audioContext.createMediaStreamSource(stream);

                    microphoneStream.connect(analyser);
                    analyser.connect(audioContext.destination);

                    analyser.fftSize = 256;
                    analyser.smoothingTimeConstant = 0.5;

                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    analyser.getByteTimeDomainData(dataArray);

                    function detectAudio() {
                        analyser.getByteTimeDomainData(dataArray);

                        const rms = Math.sqrt(Array.from(dataArray).reduce((sum, sample) => sum + Math.abs(sample) * Math.abs(sample), 0) / dataArray.length);
                        const dB = 20 * Math.log10(rms / 128.0);

                        document.getElementById('powerDisplay').innerText = `Potencia de Audio: ${dB.toFixed(2)} dB`;

                        if (dB > umbralDecibelios && !isSpeechCooldownActive()) {
                            count++;
                            const now = new Date();
                            const formattedDateTime = formatDateTime(now).split(',')[0]; // Mostrar solo la fecha sin la hora
                            const hours = now.getHours();
                            const hourText = hours % 12 === 0 ? 12 : hours % 12;
                            const minutes = now.getMinutes();
                            const seconds = now.getSeconds();
                            const minuteText = minutes < 10 ? `0${minutes}` : minutes;
                            const secondText = seconds < 10 ? `0${seconds}` : seconds;

                            const ampm = hours >= 12 ? 'PM' : 'AM'; // Obtener AM o PM
                            const dBValue = document.getElementById('powerDisplay').innerText.split(' ')[3]; // Obtener el valor de potencia
                            const evento = `${count}|${dBValue}|${formattedDateTime}|${hourText}:${minuteText}:${secondText}|${ampm}`; // Modificar el formato del mensaje
                            logEvent(evento);
                            updateEventCounter();
                            startCountdownTimer();
                            readEventCount();  // Llama a readEventCount solo aquí
                        }

                        requestAnimationFrame(detectAudio);
                    }

                    detectAudio();
                    startSpeechRecognition(); // Agregado: Iniciar reconocimiento de voz

                })
                .catch(function (err) {
                    console.error('Error al obtener acceso al micrófono: ', err);
                });
        }

        function startSpeechRecognition() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();
            recognition.lang = 'es-ES';

            recognition.onstart = function () {
                console.log('El reconocimiento de voz está activo.');
            };

            recognition.onresult = function (event) {
                const result = event.results[event.resultIndex];
                const transcript = result[0].transcript.toLowerCase();

                console.log('Transcripción de voz:', transcript);

                if (transcript.includes(startKeyword)) {
                    // Iniciar grabación al detectar la palabra clave de inicio
                    startRecording();
                } else if (transcript.includes(stopKeyword)) {
                    // Detener grabación al detectar la palabra clave de detención
                    stopRecording();
                }
            };

            recognition.onerror = function (event) {
                console.error('Error en el reconocimiento de voz:', event.error);
            };

            recognition.onend = function () {
                console.log('El reconocimiento de voz ha finalizado.');
                // Reiniciar el reconocimiento de voz después de un breve retraso
                setTimeout(startSpeechRecognition, 1000);
            };

            recognition.start();
        }

        function startCountdownTimer() {
            let countdown = speechCooldownDuration / 1000; // Convertir a segundos
            const countdownTimerElement = document.getElementById('countdownTimer');

            countdownInterval = setInterval(function () {
                countdownTimerElement.textContent = `Tiempo restante: ${countdown} segundos`;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    countdownTimerElement.textContent = ''; // Limpiar el temporizador
                }

                countdown--;
            }, 1000);
        }

        function isSpeechCooldownActive() {
            const currentTime = new Date().getTime();
            return currentTime - lastSpeechTime < speechCooldownDuration;
        }

        function stopAudioDetection() {
            if (audioContext) {
                audioContext.close();
                analyser.disconnect();
                microphoneStream.disconnect();
                clearInterval(countdownInterval); // Detener el temporizador de cuenta regresiva
                document.getElementById('countdownTimer').textContent = ''; // Limpiar el temporizador
                document.getElementById('powerDisplay').innerText = 'Potencia de Audio: 0 dB'; // Restaurar visualización de potencia
                count = 0;
                updateEventCounter();
                lastSpeechTime = 0; // Restablecer el tiempo del último discurso
            }

            stopSpeechRecognition(); // Detener el reconocimiento de voz
        }

        function updateEventCounter() {
            eventCounterElement.textContent = `Veces que se ha superado el umbral: ${count}`;
        }

        function logEvent(event) {
            if (eventLogElement) {
                const p = document.createElement('p');
                p.textContent = event;
                eventLogElement.appendChild(p);
            }
        }

        function readEventCount() {
            const message = `La potencia de audio ha superado el umbral ${count} veces.`;
            responsiveVoice.speak(message, "Spanish Female");
            lastSpeechTime = new Date().getTime(); // Actualizar el tiempo del último discurso
        }

        function stopSpeechRecognition() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();
            recognition.stop();
        }

        function saveInformation() {
            // Lógica para guardar información
            console.log('Información guardada.');
        }

        // Funciones para la grabadora de audio
        let mediaRecorder;
        let audioChunks = [];

        function startRecording() {
            const startRecordButton = document.getElementById('startRecord');
            const stopRecordButton = document.getElementById('stopRecord');
            const recordingIndicator = document.getElementById('recordingIndicator');

            startRecordButton.disabled = true;
            stopRecordButton.disabled = false;

            audioChunks = []; // Limpiar los fragmentos de audio anteriores

            const constraints = { audio: true };
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function (stream) {
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = function (event) {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = function () {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);

                        document.getElementById('audioPlayer').src = audioUrl;
                        document.getElementById('keywordRecognized').innerText = ''; // Limpiar la palabra clave reconocida
                        recordingIndicator.innerText = ''; // Limpiar el indicador visual
                        responsiveVoice.speak("Grabación completada", "Spanish Female"); // Agregado: Mensaje de voz

                        startRecordButton.disabled = false;
                        stopRecordButton.disabled = true;
                    };

                    mediaRecorder.start();
                    recordingIndicator.innerText = 'Grabando...'; // Agregado: Indicador visual
                })
                .catch(function (err) {
                    console.error('Error al iniciar la grabación: ', err);
                });
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        function formatDateTime(dateTime) {
            const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true };
            return new Intl.DateTimeFormat('es-ES', options).format(dateTime);
        }
    </script>
</body>
</html>
