<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de Audio</title>
</head>
<body>
    <h1>Detector de Audio</h1>
    <div id="eventCounter">Veces que se ha superado el umbral: 0</div>
    <button onclick="startAudioDetection()">Iniciar Detección</button>
    <button onclick="stopAudioDetection()">Detener Detección</button>
    <div id="powerDisplay">Potencia de Audio: 0 dB</div>
    <div id="eventLog"></div>
    

    <script>
        let audioContext;
        let analyser;
        let microphoneStream;
        let eventLogElement;
        let eventCounterElement;
        let count = 0;

        function startAudioDetection() {
            eventLogElement = document.getElementById('eventLog');
            eventCounterElement = document.getElementById('eventCounter');

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    microphoneStream = audioContext.createMediaStreamSource(stream);

                    microphoneStream.connect(analyser);
                    analyser.connect(audioContext.destination);

                    analyser.fftSize = 256;
                    analyser.smoothingTimeConstant = 0.5; // Ajusta este valor según sea necesario

                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    analyser.getByteTimeDomainData(dataArray);

                    function detectAudio() {
                        analyser.getByteTimeDomainData(dataArray);

                        // Calcula la potencia del audio en dB
                        const rms = Math.sqrt(Array.from(dataArray).reduce((sum, sample) => sum + Math.abs(sample) * Math.abs(sample), 0) / dataArray.length);
                        const dB = 20 * Math.log10(rms / 128.0); // Se ajusta para normalizar a 0-1

                        // Muestra la potencia del audio en la interfaz
                        document.getElementById('powerDisplay').innerText = `Potencia de Audio: ${dB.toFixed(2)} dB`;

                        // Ajusta el umbral de detección según tus necesidades (por ejemplo, 1 dB)
                        const umbralDeteccion = 1;

                        // Verifica si la potencia supera el umbral y registra el evento
                        if (dB > umbralDeteccion) {
                            const evento = `Evento detectado a las ${getCurrentTime()} con potencia ${dB.toFixed(2)} dB`;
                            logEvent(evento);
                            count++;
                            updateEventCounter();
                            readEventCount();
                        }

                        requestAnimationFrame(detectAudio);
                    }

                    detectAudio();
                })
                .catch(function (err) {
                    console.error("Error al obtener acceso al micrófono:", err);
                });
        }

        function stopAudioDetection() {
            if (microphoneStream) {
                microphoneStream.disconnect();
                analyser.disconnect();
                audioContext.close().then(() => {
                    console.log("Detección de audio detenida.");
                });
            }
        }

        function logEvent(message) {
            const eventItem = document.createElement('div');
            eventItem.innerText = message;

            // Inserta el nuevo evento al principio de la lista
            eventLogElement.insertBefore(eventItem, eventLogElement.firstChild);
        }

        function updateEventCounter() {
            eventCounterElement.innerText = `Veces que se ha superado el umbral: ${count}`;
        }

        function readEventCount() {
            // Utiliza la API de Web Speech para leer en voz alta el número de eventos detectados
            const synth = window.speechSynthesis;
            const utterance = new SpeechSynthesisUtterance(`Generando informe Número de eventos detectados: ${count}`);
            synth.speak(utterance);
        }

        function getCurrentTime() {
            const now = new Date();
            const date = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            return `${date} ${time}`;
        }
    </script>
</body>
</html>
